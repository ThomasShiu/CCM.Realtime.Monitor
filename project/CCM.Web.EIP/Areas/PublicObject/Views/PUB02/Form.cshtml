@{
    ViewBag.Title = "Form-公務車預約";
    Layout = "~/Views/Shared/_Form.cshtml";
}
<link href="~/Content/js/bootgrid/jquery.bootgrid.min.css" rel="stylesheet" />
<script src="~/Content/js/bootgrid/jquery.bootgrid.min.js"></script>
<link href="~/Content/js/ColourPicker/colorPicker.css" rel="stylesheet" />
<link href="~/Content/js/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css" rel="stylesheet" />
<script src="~/Content/js/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>

<script>
    var parentID = $('input[name=GUID]').val();
    var keyValue = $.request("keyValue");
    var depid = '@CCM.Code.OperatorProvider.Provider.GetCurrent().DeptId';
    var vStartTime = ''; var vEndTime = '';
    $(function () {
        initControl();
        if (!!keyValue) {
            // 編輯模式
            $.ajax({
                url: "/PublicObject/PUB03/GetFormJson",
                data: { keyValue: keyValue },
                dataType: "json",
                async: false,
                success: function (data) {
                    $("#form1").formSerialize(data);
                    // 顯示公共物件資料
                    showPublicObject($('#ObjectSID').children('option:selected').val());
                }
            });
            if (depid != 'G20' & depid != 'C00') {
                //$("#BookingStartTime").attr("disabled", "disabled");
                //$("#BookingEndTime").attr("disabled", "disabled");
                $("#ObjectSID").attr("disabled", "disabled");
                // 原預約時段
                vStartTime = $("#BookingStartTime").val();
                vEndTime = $("#BookingEndTime").val();
            }
        } else {
            // 新建模式
            $("#AttendDeptID").attr("required", "true");
            $("#AttendEmplyID").attr("required", "true");

            // 新建模式,取得GUID作為附件檔案使用
            $('input[name="GUID"]').val(GetNow() + '-' + GetGuid());
            parentID = $('input[name=GUID]').val();
        }

        // 初始化外出人員列表
        InitBootGrid();
    });
    function initControl() {
        $('#cp').colorpicker({
            colorSelectors: {
                '#ffffff': '#ffffff',
                '#FF0000': '#FF0000',
                '#777777': '#777777',
                '#337ab7': '#337ab7',
                '#5cb85c': '#5cb85c',
                '#5bc0de': '#5bc0de',
                '#f0ad4e': '#f0ad4e',
                '#d9534f': '#d9534f'
            }
        });

        // 部門
        $("#DepartmentID").bindSelect({
            url: "/Human/HRS00/GetHR_DEP",
            id: "DEPID",
            text: "DEPNM"
        });

        // 員工 by 部門
        $("#EmployeeID").bindSelect({
            url: "/Human/HRS00/GetHR_EMPLY" ,
            id: "EMPLYID",
            text: "EMPLYNM"
        });
        // 公共物件
        $("#ObjectSID").bindSelect({
            url: "/PublicObject/PUB00/GetPublicObject?keyword=公務車輛",
            id: "SID",
            text: "ObjectNM"
        });

        // 同行部門
        $("#AttendDeptID").bindSelect({
            url: "/Human/HRS00/GetHR_DEP",
            id: "DEPID",
            text: "DEPNM"
        });

        // 同行員工 by 部門
        //$("#AttendEmplyID").bindSelect({
        //    url: "/Human/HRS00/GetHR_EMPLY_ALL?keyword=" + $('#AttendDeptID').children('option:selected').val(),
        //    id: "EMPLYID",
        //    text: "EMPLYNM"
        //});
    }
    function submitForm() {
        if (keyValue != '') {
            // 編輯模式
            if (depid != 'C00' & depid != 'G20') {
                //檢查開始時間不可大於結束時間
                var leavetime = $('#BookingStartTime').val();
                var backtime = $('#BookingEndTime').val();

                var newTime1 = new Date(leavetime);
                var newTime2 = new Date(backtime);
                var oldTime1 = new Date(vStartTime);
                var oldTime2 = new Date(vEndTime);
                // 新開始時間不可小於原開始時間
                if (newTime1 > oldTime1) {
                    //$('#BookingStartTime').val('');
                    //$('#BookingEndTime').val('');

                    msg = "不可大於原本開始時間，請修正!";
                    window.setTimeout(function () {
                        $.modalMsg(msg, "warning");
                    }, 500);

                    //$('#BookingStartTime').focus();
                    return false;
                }
                // 新結束時間不可小於原結束時間
                if (oldTime2 > newTime2) {
                    //$('#BookingStartTime').val('');
                    //$('#BookingEndTime').val('');

                    msg = "不可小於原本結束時間，請修正!";
                    window.setTimeout(function () {
                        $.modalMsg(msg, "warning");
                    }, 500);

                    //$('#BookingEndTime').focus();
                    return false;
                }
            }
        }
        if (!$('#form1').formValid()) {
            return false;
        }
        $.submitForm({
            url: "/PublicObject/PUB02/SubmitForm?keyValue=" + keyValue,
            param: $("#form1").formSerialize(),
            success: function () {
                $.currentWindow().$("#gridList").trigger("reloadGrid");
            }
        })
    }


    function checkBookingTime() {
        //檢查開始時間不可大於結束時間
        var leavetime = $('#BookingStartTime').val();
        var backtime = $('#BookingEndTime').val();

        var fd1 = new Date(leavetime);
        var fd2 = new Date(backtime);
        if (fd1 > fd2) {
            $('#BookingStartTime').val('');
            $('#BookingEndTime').val('');

            msg = "開始時間不可大於結束時間，請修正!";
            window.setTimeout(function () {
                $.modalMsg(msg, "warning");
            }, 500);

            $('#BookingStartTime').focus();
            return false;
        }
    }

    function showPublicObject(keyword) {
        //檢查開始時間不可大於結束時間
        var leavetime = $('#BookingStartTime').val();
        var backtime = $('#BookingEndTime').val();

        var fd1 = new Date(leavetime);
        var fd2 = new Date(backtime);
        if (fd1 > fd2) {
            $('#BookingStartTime').val('');
            $('#BookingEndTime').val('');

            msg = "開始時間不可大於結束時間，請修正!";
            window.setTimeout(function () {
                $.modalMsg(msg, "warning");
            }, 500);

            $('#BookingStartTime').focus();
            return false;
        }

        // 顯示公共物件資料、圖片
        $.ajax({
            url: "/PublicObject/PUB00/GetPublicObjectSID",
            data: { keyword: keyword },
            dataType: "json",
            async: false,
            success: function (data) {
                var PhotoUrl = data[0].PhotoUrl;
                //PhotoUrl = PhotoUrl.replace("~/", "");
                $("#PhotoUrl").attr("src", pathlink + PhotoUrl);
                $("#ObjectNM").text(data[0].ObjectNM);
                $("#ObjectDescr").text(data[0].Description);
            }
        });

        // 顯示最近預約
        $.ajax({
            type: "GET",
            url: "/PublicObject/PUB02/GetCarBooking",
            data: { keyword: keyword },
            dataType: "json",
            cache: false,
            async: false,
            success: function (data) {
                var trHTML = '';
                $.each(data.CarBooking, function (i, item) {
                    trHTML += '<span  style="color:red;"><b>最近預約:</b><br/>事由:' + data.CarBooking[i].Subject + '<br/>時間:' +
                        data.CarBooking[i].BookingStartTime + '~' + data.CarBooking[i].BookingEndTime + '</span>';
                });
                $('#ObjectBooking').empty();
                $('#ObjectBooking').append(trHTML);
            },
            error: function (msg) {
                //alert(msg.responseText);
                window.setTimeout(function () {
                    $.modalMsg(msg.responseText, "warning");
                }, 500);
            }
        });
    }

    $(document).ready(function () {
        if (!keyValue) {
            // 新建模式
            $('#DepartmentID').change(function () {
                // 員工 by 部門
                $("#EmployeeID").empty().bindSelect({
                    url: "/Human/HRS00/GetHR_EMPLY?keyword=" + $(this).children('option:selected').val(),
                    id: "EMPLYID",
                    text: "EMPLYNM"
                });

            });

        }
        else {
            // 編輯模式
            //$("#DepartmentID").attr("disabled", "disabled");
            //$("#EmployeeID").attr("disabled", "disabled");
        }

        // 外出人員部門
        $('#AttendDeptID').change(function () {
            $("#AttendEmplyID").empty();
            $("#AttendEmplyID").prepend("<option value='' selected='selected'></option>");
            // 員工 by 部門
            $("#AttendEmplyID").bindSelect({
                url: "/Human/HRS00/GetHR_EMPLY?keyword=" + $(this).children('option:selected').val(),
                id: "EMPLYID",
                text: "EMPLYNM"
            });

        });
        // 外出人員
        $('#AttendEmplyID').change(function () {
            var deptId = $("#AttendDeptID option:selected").val();
            var deptNm = $("#AttendDeptID option:selected").html();
            var empId = $("#AttendEmplyID option:selected").val();
            var empNm = $("#AttendEmplyID option:selected").html();
            //alert(deptId + ',' + deptNm + ',' + empId + ',' + empNm);

            // todo: 寫入外出人員表格
            btn_addDetail();
        });

        //$("#ObjectType").attr("disabled", "disabled");

        $('#ObjectSID').change(function () {
            // 顯示公共物件資料
            showPublicObject($('#ObjectSID').children('option:selected').val());

        });
        // 預計出廠時間
        //$('#BookingStartTime').change(function () {
        //    var leavetime = $('#BookingStartTime').val();
        //    $('#LeaveTime').val(leavetime);

        //});
        // 預計回廠時間
        //$('#BookingEndTime').change(function () {
        //    var backtime = $('#BookingEndTime').val();
        //    $('#BackTime').val(backtime);

        //});

    });

    // 新增外出人員
    function btn_addDetail() {
        var deptId = $("#AttendDeptID option:selected").val();
        var deptNm = $("#AttendDeptID option:selected").html();
        var empId = $("#AttendEmplyID option:selected").val();
        var empNm = $("#AttendEmplyID option:selected").html();
        try {
            var submitJson = {
                DepID: deptId,
                EmpID: empId,
                ParentSID: parentID
            }
            //alert($("#D_DepID").val()); alert($('#D_EmpID').val());
            $.ajax({
                url: "/PublicObject/PUB02/SubmitAttendEmp",
                data: { submitJson: JSON.stringify(submitJson) },
                dataType: "json",
                async: false,
                success: function (data) {
                    //alert(data.state);
                    msg = "新增外出人員成功!";
                    //window.setTimeout(function () {
                    //    $.modalMsg(msg, "success");
                    //}, 500);

                    //重新整理附件列表
                    $('#grid-AttendEmp').bootgrid('reload');
                },
                error: function (data) {
                    msg = "新增外出人員發生異常!";
                    window.setTimeout(function () {
                        $.modalMsg(msg, "warning");
                    }, 500);
                }
            });
        }
        catch (err) {
            msg = err.message;
            window.setTimeout(function () {
                $.modalMsg(msg, "warning");
            }, 500);
        }
    }

    // 初始化附件列表
    function InitBootGrid() {
        parentID = $('input[name=GUID]').val();
        // BootGrid test
        $("#grid-AttendEmp").on("load.rs.jquery.bootgrid", function () {
            //alert('before load data');
        }).bootgrid({
            ajax: true,
            height: 100,
            navigation:0,
            ajaxSettings: {
                method: "GET",
                cache: false
            },
            templates: {
                search: ""
            },
            right: "text-right",
            labels: {
                noResults: "無任何明細",
                infos: '{{ctx.start}} / {{ctx.end}}，共 {{ctx.total}}筆'
            },
            rowCount: -1,
            post: function () {
                /* To accumulate custom parameter with the request object */
                return {
                    id: "b0df282a-0d67-40e5-8558-c9e93b7befed"
                };
            },
            url: '/PublicObject/PUB00/GetAttendEmpList?keyword=' + parentID,
            formatters: {
                "commands": function (column, row) {
                    return "<button type=\"button\" class=\"btn btn-xs btn-default command-delete\" data-row-id=\"" + row.SID + "\" data-row-pid=\"" + row.ParentSID + "\"><span class=\"fa fa-trash-o\"></span></button>";
                }
            }
        }).on("loaded.rs.jquery.bootgrid", function () {

            //alert('after load data');
            /* Executes after data is loaded and rendered */
            $("#grid-AttendEmp").find(".command-delete").on("click", function (e) {
                var depid = '@CCM.Code.OperatorProvider.Provider.GetCurrent().DeptId';
                //if (depid == 'C00' | depid == 'G20') {
                    // 刪除檔案
                    $.ajax({
                        type: "POST",
                        url: "/PublicObject/PUB02/DeleteAttendEmp",
                        data: { keyValue: $(this).data("row-id"), keyValue2: $(this).data("row-pid") },
                        dataType: "json",
                        async: true,
                        success: function (res) {
                            //alert('SUCCESS:刪除作業完成!');
                            //alert(res.message);
                            $('#grid-AttendEmp').bootgrid('reload');
                            var msg;
                            if (res.state == "success") {
                                msg = "已成功刪除！";
                                window.setTimeout(function () {
                                    $.modalMsg(msg, "success");
                                }, 500);

                                //重新整理附件列表
                                $('#grid-AttendEmp').bootgrid('reload');
                            }
                            else {
                                msg = "刪除失敗，原因：" + res.message;
                                window.setTimeout(function () {
                                    $.modalMsg(msg, "error");
                                }, 500);
                            }

                        },
                        failure: function (errMsg) {
                            //msg ='刪除作業出現錯誤!';
                            window.setTimeout(function () {
                                $.modalMsg(errMsg, "error");
                            }, 500);
                        }
                    });
                //} else {
                //    msg = "請管理部總務人員協助刪除!";
                //    window.setTimeout(function () {
                //        $.modalMsg(msg, "warning");
                //    }, 500);
                //}
            });
        });

    }
</script>

<form id="form1">
    <input id="SID" name="SID" type="hidden" value="" />
    <input id="GUID" name="GUID" type="hidden" value="" />
    <input id="MileageLast" name="MileageLast" type="hidden" value="0" />
    <input id="Mileage" name="Mileage" type="hidden"  value="0" />
    <input id="LeaveTime" name="LeaveTime" type="hidden" value="" />
    <input id="BackTime" name="BackTime" type="hidden" value="" />
    
    <input id="BgColor" name="BgColor" type="hidden" value="" />
    <input id="CreatorUserId" name="CreatorUserId" type="hidden" value="" />
    @*<input id="ObjectType" name="ObjectType" type="hidden" value="公務車輛"  />*@

    <div style="padding-top: 20px; margin-right: 20px;">
        <table class="form">
            <tr>
                <th class="formTitle">預約對象</th>
                <td class="formValue">
                    @*<input id="UseReason" name="UseReason" type="text" class="form-control required" placeholder="請輸入標題" />*@
                    <select id="ObjectType" name="ObjectType" class="form-control required">
                        <option value="公務車輛" selected="selected">公務車輛</option>
                        <option value="私人車輛" >私人車輛</option>
                    </select>
                </td>
                <th class="formTitle">預約原因</th>
                <td class="formValue">
                    <select id="UseReason" name="UseReason" class="form-control required">
                        <option>內部需求</option>
                        <option>客戶來訪</option>
                        <option>廠商來訪</option>
                        <option>訪問客戶</option>
                        <option>訪問廠商</option>
                        <option>廠區觀摩</option>
                        <option>私人需求</option>
                    </select>
                </td>
                <th class="formTitle">外出人員部門</th>
                <td class="formValue">
                    <select id="AttendDeptID" name="AttendDeptID" class="form-control ">
                        <option></option>
                    </select>
                </td>
            </tr>
            <tr>
                <th class="formTitle">申請部門</th>
                <td class="formValue">
                    <select id="DepartmentID" name="DepartmentID" class="form-control required">
                        <option value="@CCM.Code.OperatorProvider.Provider.GetCurrent().DeptId">@CCM.Code.OperatorProvider.Provider.GetCurrent().DeptName</option>
                    </select>
                </td>
                <th class="formTitle">申請人員</th>
                <td class="formValue">
                    <select id="EmployeeID" name="EmployeeID" class="form-control required">
                        <option value="@CCM.Code.OperatorProvider.Provider.GetCurrent().UserCode">@CCM.Code.OperatorProvider.Provider.GetCurrent().UserName</option>
                    </select>
                </td>
                <th class="formTitle">外出人員</th>
                <td class="formValue">
                    <select id="AttendEmplyID" name="AttendEmplyID" class="form-control ">
                        <option></option>
                        @*<option value="@CCM.Code.OperatorProvider.Provider.GetCurrent().UserCode">@CCM.Code.OperatorProvider.Provider.GetCurrent().UserName</option>*@
                    </select>
                </td>
            </tr>
            <tr>
                <th class="formTitle">車輛編號</th>
                <td class="formValue" colspan="3">
                    <select id="ObjectSID" name="ObjectSID" class="form-control required" >
                        <option value=""></option>
                    </select>
                </td>

                <td class="formValue" colspan="2" rowspan="3" style="background-color:gainsboro">
                    <table id="grid-AttendEmp" class="table table-condensed table-hover table-striped">
                        <thead>
                            <tr>
                                <th data-column-id="SID" data-width="20%" data-visible="false">SID</th>
                                <th data-column-id="ParentSID" data-width="20%" data-visible="false">ParentSID</th>
                                <th data-column-id="DEPNM" data-width="80px" >部門</th>
                                <th data-column-id="EMP_NM" data-width="45px">外出人員</th>
                                <th data-column-id="commands" data-width="30px" data-formatter="commands" data-sortable="false">執行</th>
                            </tr>
                        </thead>
                    </table>
                    @*<textarea id="AttendEmp" name="AttendEmp" class="form-control" style="height: 100px;"></textarea>*@
                </td>
            </tr>

            <tr>
                <th class="formTitle">預約時間起</th>
                <td class="formValue">
                    <input id="BookingStartTime" name="BookingStartTime" type="text" class="form-control input-wdatepicker required" 
                           onfocus="WdatePicker({ startDate: '%y/%M/%d %H:%m', dateFmt: 'yyyy/MM/dd HH:mm',alwaysUseStartDate: false,qsEnabled: true, quickSel: ['%y-%M-%d 08:00', '%y-%M-%d 09:00', '%y-%M-%d 10:00', '%y-%M-%d 13:00', '%y-%M-%d 14:00', '%y-%M-%d 15:00'] })" placeholder="請輸入開始時間" />
                </td>
                <th class="formTitle">預約時間迄</th>
                <td class="formValue">
                    <input id="BookingEndTime" name="BookingEndTime" type="text" class="form-control input-wdatepicker required"  
                           onfocus="WdatePicker({ startDate: '%y/%M/%d %H:%m', dateFmt: 'yyyy/MM/dd HH:mm', alwaysUseStartDate: false, qsEnabled: true, quickSel: ['%y-%M-%d 12:00', '%y-%M-%d 14:00', '%y-%M-%d 15:30', '%y-%M-%d 16:00', '%y-%M-%d 17:00', '%y-%M-%d 16:00'] })" placeholder="請輸入結束時間" />
                </td>

            </tr>


    
            <tr>
@{
    var depid = CCM.Code.OperatorProvider.Provider.GetCurrent().DeptId;
    if (depid == "G00" | depid == "G10" | depid == "G20" | depid == "C00")
    {
                <th class="formTitle">實際時間起</th>
                <td class="formValue">
                    <input id="LeaveTime" name="LeaveTime" type="text" class="form-control input-wdatepicker "
                           onfocus="WdatePicker({ startDate: '%y/%M/%d %H:%m', dateFmt: 'yyyy/MM/dd HH:mm'})" placeholder="請輸入開始時間" />
                </td>
                <th class="formTitle">實際時間迄</th>
                <td class="formValue">
                    <input id="BackTime" name="BackTime" type="text" class="form-control input-wdatepicker "
                           onfocus="WdatePicker({ startDate: '%y/%M/%d %H:%m', dateFmt: 'yyyy/MM/dd HH:mm'})" placeholder="請輸入結束時間" />
                </td>
    }
}
            </tr>
   

            <tr>
                <th class="formTitle">用途說明</th>
                <td class="formValue" colspan="3">
                    <input id="Subject" name="Subject" type="text" class="form-control required" />
                </td>
                <th class="formTitle">背景顏色</th>
                <td class="formValue">
                    @*<input type="text" id="BgColor" name="BgColor"  class="form-control required"/>*@
                    <div id="cp" data-format="alias" class="input-group colorpicker-component">
                        <input id="BgColor" name="BgColor" type="text" value="#337ab7" class="form-control" />
                        <span class="input-group-addon"><i></i></span>
                    </div>
                   
                </td>
            </tr>
            <tr>
                <th class="formTitle">詳細說明</th>
                <td class="formValue" colspan="3">
                    <textarea id="Description" name="Description" class="form-control required" style="height: 50px;"></textarea>
                </td>
                <th class="formTitle">狀態</th>
                <td class="formValue">
                    @*<input type="text" id="BgColor" name="BgColor"  class="form-control required"/>*@
                        <select id="Status" name="Status" class="form-control ">
                            <option></option>
                            <option>鎖定</option>
                            <option>取消</option>
                            <option>結束</option>
                        </select>
                </td>
            </tr>
            <tr>
                <th class="formTitle" colspan="3"><img src="" id="PhotoUrl" name="PhotoUrl" style="height:150px;"/></th>
                <td class="formValue" colspan="3">
                    <span id="ObjectNM" name="ObjectNM"></span>
                    <br /><br />
                    <span id="ObjectDescr" name="ObjectDescr"></span>
                    <br /><br />
                    <span id="ObjectBooking" name="ObjectBooking"></span>
                </td>
            </tr>

        </table>
    </div>
</form>