@{
    ViewBag.Title = "Form";
    Layout = "~/Views/Shared/_Form.cshtml";
}
<link href="~/Content/js/bootgrid/jquery.bootgrid.min.css" rel="stylesheet" />
<script src="~/Content/js/bootgrid/jquery.bootgrid.min.js"></script>
<script>
    var keyValue = $.request("keyValue");
    var parentID = $.request("SID");
    $(function () {
        initControl();
        if (!!keyValue) {
            $.ajax({
                url: "/OrderManage/ORD02/GetFormJson",
                data: { keyValue: keyValue },
                dataType: "json",
                async: false,
                success: function (data) {
                    $("#form1").formSerialize(data);
                }
            });
        } else {
            // 新增模式
            blockDisable();
            
        }
        $("#D_OrderDate").val(GetToday());
        // 初始化訂便當明細列表
        InitBootGrid();
    });
    function initControl() {
        // 部門
        $("#DepartmentID").bindSelect({
            url: "/Human/HRS00/GetHR_DEP",
            id: "DEPID",
            text: "DEPNM"
        });

        // 員工 by 部門
        $("#EmployeeID").bindSelect({
            url: "/Human/HRS00/GetHR_EMPLY_ALL",
            id: "EMPLYID",
            text: "EMPLYNM"
        });

        // 特約商店
        $("#StoreID").bindSelect({
            url: "/OrderManage/ORD00/GetStoreJsonList",
            id: "SID",
            text: "NAME"
        });
        // 部門
        $("#D_DepID").bindSelect({
            url: "/Human/HRS00/GetHR_DEP",
            id: "DEPID",
            text: "DEPNM"
        });

        // 員工 by 部門
        $("#D_EmpID").bindSelect({
            url: "/Human/HRS00/GetHR_EMPLY_ALL",
            id: "EMPLYID",
            text: "EMPLYNM"
        });

        // 菜單
        $("#D_OrderMenuSID").bindSelect({
            url: "/OrderManage/ORD00/GetMenuListPID?keyValue=" + $('#StoreID').children('option:selected').val(),
            id: "SID",
            text: "MealsName"
        });

    }
    function submitForm() {
        if (!$('#form1').formValid()) {
            return false;
        }
        $.submitForm({
            url: "/OrderManage/ORD02/SubmitForm?keyValue=" + keyValue,
            param: $("#form1").formSerialize(),
            success: function () {
                $.currentWindow().$("#gridList").trigger("reloadGrid");
            }
        })
    }

    function btn_addDetail() {
        //var keyValue = $("#gridList").jqGridRowValue().SID;
        if ($("#D_DepID").val() == "" | $('#D_EmpID').val() == "" | $('#D_OrderDate').val() == "" |
            $('#D_OrderMenuSID').val() == "" | $('#D_UnitPrice').val() == "" | $('#D_Qty').val() == "") {
            msg = "請確實填寫各欄位!";
            window.setTimeout(function () {
                $.modalMsg(msg, "error");
            }, 500);
            return;
        }

        try{
            var submitJson = {
                DepID: $("#D_DepID").val(),
                EmpID: $('#D_EmpID').val(),
                OrderDate: $('#D_OrderDate').val(),
                OrderMenuSID: $('#D_OrderMenuSID').val(),
                UnitPrice: $('#D_UnitPrice').val(),
                Qty: $('#D_Qty').val(),
                ParentSID: keyValue
            }
            //alert($("#D_DepID").val()); alert($('#D_EmpID').val());
            $.ajax({
                url: "/OrderManage/ORD02/SubmitDetail",
                data: { submitJson: JSON.stringify(submitJson) },
                dataType: "json",
                async: false,
                success: function (data) {
                    //alert(data.state);
                    msg = "新增訂購明細成功!";
                    window.setTimeout(function () {
                        $.modalMsg(msg, "success");
                    }, 500);
                    $.currentWindow().$("#gridList").trigger("reloadGrid");
                    //重新整理附件列表
                    $('#grid-orderlist').bootgrid('reload');
                },
                error: function (data) {
                    msg = "新增訂購明細發生異常!";
                    window.setTimeout(function () {
                        $.modalMsg(msg, "warning");
                    }, 500);
                }
            });}
        catch (err) {
            msg = err.message;
            window.setTimeout(function () {
                $.modalMsg(msg, "warning");
            }, 500);
        }
    }

    function blockDisable() {
        toggleDisabled(document.getElementById("adddetail"));
    }

    // 停用DIV內容
    function toggleDisabled(el) {
        try {
            el.disabled = el.disabled ? false : true;
        }
        catch (E) {
        }
        if (el.childNodes && el.childNodes.length > 0) {
            for (var x = 0; x < el.childNodes.length; x++) {
                toggleDisabled(el.childNodes[x]);
            }
        }
    }

    // 初始化附件列表
    function InitBootGrid() {

        // BootGrid test
        $("#grid-orderlist").on("load.rs.jquery.bootgrid", function () {
            //alert('before load data');
        }).bootgrid({
            ajax: true,
            height: 100,
            navigation: 2,
            ajaxSettings: {
                method: "GET",
                cache: false
            },
            templates: {
                search: ""
            },
            right: "text-right",
            labels: {
                noResults: "無任何明細",
                infos: '顯示 {{ctx.start}} 到 {{ctx.end}} 筆，總共 {{ctx.total}} 筆'
            },
            rowCount: -1,
            post: function () {
                /* To accumulate custom parameter with the request object */
                return {
                    id: "b0df282a-0d67-40e5-8558-c9e93b7befed"
                };
            },
            url: '/OrderManage/ORD00/GetOrderDetailList?keyword=' + keyValue,
            formatters: {
                "ORDERDATEFORMAT": function (column, row) {
                    var strDate = row.ORDERDATE.substring(6, 9) + "/" + row.ORDERDATE.substring(4, 6) + "/" + row.ORDERDATE.substring(0, 4);
                    return strDate;
                }
            }
        })

    }

    $(document).ready(function () {
        if (!keyValue) {
            // 新建模式
            $('#DepartmentID').change(function () {
                // 員工 by 部門
                $("#EmployeeID").empty().bindSelect({
                    url: "/Human/HRS00/GetHR_EMPLY?keyword=" + $(this).children('option:selected').val(),
                    id: "EMPLYID",
                    text: "EMPLYNM"
                });

            });

        } else {
            // 編輯模式
            // 訂購員工
            $('#D_DepID').change(function () {
                // 員工 by 部門
                $("#D_EmpID").empty().bindSelect({
                    url: "/Human/HRS00/GetHR_EMPLY?keyword=" + $(this).children('option:selected').val(),
                    id: "EMPLYID",
                    text: "EMPLYNM"
                });

            });

            // 菜單 by 特約廠商
            $('#StoreID').change(function () {
                $("#D_OrderMenuSID").bindSelect({
                    url: "/OrderManage/ORD00/GetMenuListPID?keyValue=" + $(this).children('option:selected').val(),
                    id: "SID",
                    text: "MealsName"
                });
            });

            // 單價 by 菜單
            $('#D_OrderMenuSID').change(function () {
                $.ajax({
                    type: "GET",
                    url: "/OrderManage/ORD00/GetMenuListSID",
                    data: { keyValue: $(this).children('option:selected').val() },
                    dataType: "json",
                    async: true,
                    success: function (data) {
                        $.each(data, function (index, element) {
                            //alert(element.UnitPrice);
                            $("#D_UnitPrice").val(element.UnitPrice);
                            $("#D_Qty").val(1);
                        });
                    },
                    failure: function (errMsg) {
                        
                    }
                });
            });
        }
      
        

    });
</script>
<input id="SID" name="SID" type="hidden" />
<input id="GUID" name="GUID" type="hidden" value="" />
<input id="WhoCanSee" name="WhoCanSee" type="hidden" />
            <div id="adddetail">
                <table class="form">
                    <tr>
                        <th class="formTitle">訂購部門</th>
                        <td class="formValue">
                            <select id="D_DepID" name="D_DepID" class="form-control required">
                                <option value="@CCM.Code.OperatorProvider.Provider.GetCurrent().DeptId">@CCM.Code.OperatorProvider.Provider.GetCurrent().DeptName</option>
                            </select>
                        </td>
                        <th class="formTitle">訂購人</th>
                        <td class="formValue">
                            <select id="D_EmpID" name="D_EmpID" class="form-control required">
                                <option value="@CCM.Code.OperatorProvider.Provider.GetCurrent().UserCode">@CCM.Code.OperatorProvider.Provider.GetCurrent().UserName</option>
                            </select>
                        </td>
                        <th class="formTitle">訂購日</th>
                        <td class="formValue">
                            <input id="D_OrderDate" name="D_OrderDate" type="text" class="form-control input-wdatepicker required" 
                                   onfocus="WdatePicker({ startDate: '%y-%M-%d', dateFmt: 'yyyy-MM-dd', alwaysUseStartDate: true })" placeholder="請輸入訂購時間" />
                        </td>

                    </tr>
                    <tr>
                        <th class="formTitle">訂購項目</th>
                        <td class="formValue">
                            <select id="D_OrderMenuSID" name="D_OrderMenuSID" class="form-control required">
                                <option></option>
                            </select>
                        </td>
                        <th class="formTitle">單價</th>
                        <td class="formValue">
                            <input id="D_UnitPrice" name="D_UnitPrice" type="text" class="form-control required" placeholder="請輸入單價" />
                        </td>
                        <th class="formTitle">數量</th>
                        <td class="formValue">
                            <input id="D_Qty" name="D_Qty" type="text" class="form-control required" placeholder="請輸入數量" />
                        </td>

                    </tr>
                    <tr>
                        <th class="formTitle"></th>
                        <td class="formValue">
                            <a id="btn_add" class="btn btn-info dropdown-text" onclick="btn_addDetail()"><i class="fa fa-plus"></i> 新增明細</a>
                            
                        </td>
                        <th class="formTitle">廠商</th>
                        <td class="formValue">
                            <select id="StoreID" name="StoreID" class="form-control " disabled="disabled"></select>
                        </td>
                    </tr>
                </table>
            </div>
            <div>
    <table id="grid-orderlist" class="table table-condensed table-hover table-striped">
        <thead>
            <tr>
                <th data-column-id="SID" data-width="20%" data-visible="false">SID</th>
                <th data-column-id="PARENTSID" data-width="20%" data-visible="false">PARENTSID</th>
                <th data-column-id="DEPNM" data-width="100px">訂購部門</th>
                <th data-column-id="EMPNM" data-width="50px">訂購人</th>
                <th data-column-id="MEALSNAME" data-width="70px">訂購項目</th>
                <th data-column-id="UNITPRICE" data-width="40px">單價</th>
                <th data-column-id="QTY" data-width="50px">數量</th>
                <th data-column-id="AdjustSID" data-width="50px" data-visible="false">增購項</th>
                <th data-column-id="AdjustAmount" data-width="50px" data-visible="false">增購額</th>
                <th data-column-id="AdjustQty" data-width="50px" data-visible="false">增購量</th>
                <th data-column-id="ORDERDATE" data-width="70px">訂購日</th>
                <th data-column-id="AMOUNT" data-width="50px" class="right">金額</th>
                <th data-column-id="REMARK" data-width="50px" data-visible="false">備註</th>
            </tr>
        </thead>
    </table>
</div>

            



