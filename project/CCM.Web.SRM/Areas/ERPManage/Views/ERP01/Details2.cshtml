
@{
    ViewBag.Title = "Form";
    Layout = "~/Views/Shared/_Form.cshtml";
}

<div class="widget-body">
    <div id="wizard" class="wizard" data-target="#wizard-steps" style="border-left: none; border-top: none; border-right: none;">
        <ul class="steps">
            <li data-target="#step-1" class="active"><span class="step">1</span>料件資料<span class="chevron"></span></li>
            <li data-target="#step-2"><span class="step">2</span>附加檔案(照片)<span class="chevron"></span></li>
        </ul>
    </div>

    <div class="step-content" id="wizard-steps" style="border-left: none; border-bottom: none; border-right: none;">

        <div class="step-pane active" id="step-1" style="margin: 10px; margin-bottom: 0px;">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">表單內容</h3>
                </div>
                <div class="panel-body" style="width: 98%;">

                    <form id="form1">
                        <input id="SID" name="SID" type="hidden" value="" />
                        <input id="GUID" name="GUID" type="hidden" value="" />
                        <input id="ITEM_SP" name="ITEM_SP" type="hidden" value="" />
                        <div style="padding-top: 20px; margin-right: 20px;">
                            <table class="form">

                                <tr>
                                    <th class="formTitle">CLAS_NO</th>
                                    <td class="formValue">
                                        <select id="CLAS_NO" name="CLAS_NO" class="form-control required">
                                            <option></option>
                                        </select>
                                    </td>
                                    <th class="formTitle">CLAS_NM</th>
                                    <td class="formValue">
                                        <input id="CLAS_NM" name="CLAS_NM" type="text" class="form-control required" />
                                    </td>
                                </tr>
                                <tr>
                                    <th class="formTitle">ITEM_NO</th>
                                    <td class="formValue">
                                        <select id="ITEM_NO" name="ITEM_NO" class="form-control required"><option></option></select>
                                    </td>
                                    <th class="formTitle">ITEM_NM</th>
                                    <td class="formValue">
                                        <input id="ITEM_NM" name="ITEM_NM" type="text" class="form-control required" />
                                    </td>
                                </tr>


                            </table>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="step-pane" id="step-2" style="margin: 5px; margin-bottom: 0px;">

            <div  style="background-color:paleturquoise">
                <table id="grid-attachfile" class="table table-condensed table-hover table-striped">
                    <thead>
                        <tr>
                            <th data-column-id="SID" data-width="20%" data-visible="false">序號</th>
                            <th data-column-id="OldFileName" data-width="50%">檔名</th>
                            <th data-column-id="commands" data-width="20%" data-formatter="commands" data-sortable="false">執行</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>

    </div>

    <div class="form-button" id="wizard-actions">
        <a id="btn_last" disabled class="btn btn-default btn-prev">上一步</a>
        <a id="btn_next" class="btn btn-default btn-next">下一步</a>
        <a id="btn_finish" class="btn btn-default" style="display: none;" onclick="submitForm()">完成</a>
    </div>
</div>


<link href="~/Content/js/dropzone/dropzone.css" rel="stylesheet" />
<script src="~/Content/js/dropzone/dropzone.js"></script>
<link href="~/Content/js/bootgrid/jquery.bootgrid.min.css" rel="stylesheet" />
<script src="~/Content/js/bootgrid/jquery.bootgrid.min.js"></script>
<script>
    var parentID = $('input[name=GUID]').val();
    var keyValue = $.request("keyValue");
    var keyword = $.request("keyword");
    $(function () {
        initControl();
        if (!!keyValue) {
            $.ajax({
                url: "/ERPManage/ERP01/GetFormJson",
                data: { keyValue: keyValue },
                dataType: "json",
                async: false,
                success: function (data) {
                    $("#form1").formSerialize(data);
                }
            });
            parentID = $('input[name=GUID]').val();

            $("#CLAS_NO").attr("disabled", "disabled");
            $("#CLAS_NM").attr("disabled", "disabled");
            $("#ITEM_NO").attr("disabled", "disabled");
            $("#ITEM_NM").attr("disabled", "disabled");
        } else {
            // 新建模式,取得GUID作為附件檔案使用
            $('input[name="GUID"]').val(GetNow() + '-' + GetGuid());
            parentID = $('input[name=GUID]').val();
        }

        //初始化BootGrid
        InitBootGrid();
    });
    function initControl() {
        // 料件分類
        $("#CLAS_NO").bindSelect({
            url: "/ERPManage/ERP00/GetITCLASList",
            id: "CLAS_NO",
            text: "DESCR"
        });

        // 依據料件分類代出料件
        $("#ITEM_NO").bindSelect({
            url: "/ERPManage/ERP00/GetITEMList?keyword=" + keyword,
            id: "ITEM_NO",
            text: "DESCR"
        });
        $('#wizard').wizard().on('change', function (e, data) {
            var $finish = $("#btn_finish");
            var $next = $("#btn_next");
            if (data.direction == "next") {
                switch (data.step) {
                    case 1:
                        if (!$('#form1').formValid()) {
                            return false;
                        }
                        $finish.show();
                        $next.hide();
                        break;
                    default:
                        break;
                }
            } else {
                $finish.hide();
                $next.show();
            }
        });
    }
    function submitForm() {
        if (!$('#form1').formValid()) {
            return false;
        }
        $.submitForm({
            url: "/ERPManage/ERP01/SubmitForm?keyValue=" + keyValue,
            param: $("#form1").formSerialize(),
            success: function () {
                $.currentWindow().$("#gridList").trigger("reloadGrid");
            }
        })
    }



    // 初始化附件列表
    function InitBootGrid() {
        var vhost = '@Request.Url.Host';
        var vport = '@Request.Url.Port';
        var pathlink ='';
        if (vport != '80') {
            vport = ':@Request.Url.Port';
            pathlink = 'http://' + vhost + vport + '/';
            //alert(pathlink);
        }
        else {
            pathlink = 'http://' + vhost + '/';
            //alert(pathlink);
        }

        // BootGrid test
        $("#grid-attachfile").on("load.rs.jquery.bootgrid", function () {
            //alert('before load data');
        }).bootgrid({
            ajax: true,
            navigation: 2,
            ajaxSettings: {
                method: "GET",
                cache: false
            },
            templates: {
                search: ""
            },
            labels: {
                noResults: "無任何附件",
                infos: '顯示 {{ctx.start}} 到 {{ctx.end}} 筆，總共 {{ctx.total}} 筆'
            },
            rowCount: -1,
            post: function () {
                /* To accumulate custom parameter with the request object */
                return {
                    id: "b0df282a-0d67-40e5-8558-c9e93b7befed"
                };
            },
            url: '/ERPManage/ERP01/GetGridJsonDownload?keyword=' + parentID,
            formatters: {
                "link": function (column, row) {
                    return "<a href='" + pathlink + row.DownloadPath + "' target='_blank'> Download : " + row.OldFileName + "</a>";
                },
                "commands": function (column, row) {
                    return "<button type=\"button\" class=\"btn btn-xs btn-default command-link\" data-row-id=\"" + row.DownloadPath + "\"><span class=\"fa fa-link\"></span></button> " ;
                }
            }
        }).on("loaded.rs.jquery.bootgrid", function () {

            //alert('after load data');
            /* Executes after data is loaded and rendered */
            $("#grid-attachfile").find(".command-link").on("click", function (e) {
                // 開啟檔案連結
                window.open(pathlink + $(this).data("row-id"), '_blank');
            }).end().find(".command-delete").on("click", function (e) {
                // 刪除檔案
                $.ajax({
                    type: "POST",
                    url: "/ERPManage/ERP01/DeleteFile",
                    data: { keyValue: $(this).data("row-id") },
                    dataType: "json",
                    async: true,
                    success: function (res) {
                        //alert('SUCCESS:刪除作業完成!');
                        $('#grid-attachfile').bootgrid('reload');
                        var msg;
                        if (res.Result) {
                            msg = "已成功刪除" + res.Count + "個檔案！";
                            window.setTimeout(function () {
                                $.modalMsg(msg, "success");
                            }, 500);
                            //重新整理附件列表
                            $('#grid-attachfile').bootgrid('reload');

                        }
                        else {
                            msg = "刪除失敗，原因：" + res.Message;
                            window.setTimeout(function () {
                                $.modalMsg(msg, "error");
                            }, 500);
                        }

                    },
                    failure: function (errMsg) {
                        //msg ='刪除作業出現錯誤!';
                        window.setTimeout(function () {
                            $.modalMsg(errMsg, "error");
                        }, 500);
                    }
                });
            });
        });

    }

    $(document).ready(function () {

        $('#CLAS_NO').change(function () {

            var descr = $(this).children('option:selected').text();
            var clasno_array = new Array();
            clasno_array = descr.split(',');
            //alert(prodno_array[3]);
            if (clasno_array[1] != '' | clasno_array[1] != 'undefined') {
                $('#CLAS_NM').val(clasno_array[1]);
            }

            // 依據料件分類代出料件
            $("#ITEM_NO").bindSelect({
                url: "/ERPManage/ERP00/GetITEMList?keyword=" + $(this).children('option:selected').val(),
                id: "ITEM_NO",
                text: "DESCR"
            });

        });

        $('#ITEM_NO').change(function () {

            var descr = $(this).children('option:selected').text();
            var item_array = new Array();
            item_array = descr.split(',');
            //alert(prodno_array[3]);
            if (item_array[1] != '' | item_array[1] != 'undefined') {
                $('#ITEM_NM').val(item_array[1]);
            }

        });
    });
</script>