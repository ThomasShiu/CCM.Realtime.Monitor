@*@model CCM.Web.EIP.Areas.PublicObject.Models.UploadItemViewModel*@
@{
    ViewBag.Title = "Form";
    Layout = "~/Views/Shared/_Form.cshtml";
}
    <script>
var keyValue = $.request("keyValue");
$(function () {
    initControl();
    if (!!keyValue) {
        $.ajax({
            url: "/PublicObject/PUB01/GetFormJson",
            data: { keyValue: keyValue },
            dataType: "json",
            async: false,
            success: function (data) {
                $("#form1").formSerialize(data);

            }
        });

        var PhotoUrl = $('input[name=PhotoUrl]').val();
        //PhotoUrl = PhotoUrl.replace("~/", "");
        $("#ObjectPhotoUrl").attr("src", pathlink + PhotoUrl);
    }
});
function initControl() {
    
    //$("#F_OrganizeId").bindSelect({
    //    url: "/SystemManage/Organize/GetTreeSelectJson",
    //});
}
function submitForm() {
    if (!$('#form1').formValid()) {
        return false;
    }
    $.submitForm({
        url: "/PublicObject/PUB01/SubmitForm?keyValue=" + keyValue,
        param: $("#form1").formSerialize(),
        success: function () {
            $.currentWindow().$("#gridList").trigger("reloadGrid");
        }
    })
}
    </script>

    <form id="form1">
        <div style="padding-top: 20px; margin-right: 20px;">
            <table class="form">
                <tr>
                    <th class="formTitle">類型</th>
                    <td class="formValue">
                        <select id="ObjectType" name="ObjectType" class="form-control">
                            <option value="公務車輛">公務車輛</option>
                            <option value="會議室">會議室</option>
                            <option value="其他物品">其他物品</option>
                        </select>
                        <input id="SID" name="SID" type="hidden" value="" />
                    </td>
                    <th class="formTitle">啟用</th>
                    <td class="formValue">
                        <select id="Enable" name="Enable" class="form-control ">
                            <option value="Y">啟用</option>
                            <option value="N">停用</option>
                        </select>
                    </td>
                </tr>
                <tr>
                   
                    <th class="formTitle">啟用日期</th>
                    <td class="formValue">
                        <input id="EnableDate" name="EnableDate" type="text" class="form-control input-wdatepicker" onfocus="WdatePicker()" />
                    </td>
                    <th class="formTitle">(車)保養里程</th>
                    <td class="formValue">
                        <input id="Mileage" name="Mileage" type="text" class="form-control required" placeholder="請輸入保養里程" />
                    </td>
                </tr>
                
                <tr>
                    
                    <th class="formTitle">(車)保養每公里數</th>
                    <td class="formValue">
                        <input id="MaintenanceMileage" name="MaintenanceMileage" type="text" class="form-control required" placeholder="請輸入保養公里數" />
                    </td>
                    <th class="formTitle">保養日</th>
                    <td class="formValue">
                        <input id="MaintenanceDate" name="MaintenanceDate" type="text" class="form-control required" placeholder="請輸入保養日" />
                    </td>
                </tr>

             <tr>
                 <th class="formTitle">名稱</th>
                 <td class="formValue" colspan="3">
                     <input id="ObjectNM" name="ObjectNM" type="text" class="form-control required" placeholder="請輸入名稱" />
                 </td>
             </tr>
                <tr>
                    <th class="formTitle" valign="top" style="padding-top: 5px;">
                        描述
                    </th>
                    <td class="formValue" colspan="3">
                        <textarea id="Description" name="Description" class="form-control required" style="height: 50px;"  placeholder="請輸入描述"></textarea>
                    </td>
                </tr> 
                <tr>
                    <th class="formTitle">照片</th>
                    <td class="formValue" colspan="3">
                        <input id="PhotoUrl" name="PhotoUrl" type="hidden" value="" />
                        <div>
                            <input type="file" id="FileUpload1" />
                            <input type="button" id="btnUpload" value="Upload Files" />
                            
                        </div>
                        <img src="" id="ObjectPhotoUrl" name="ObjectPhotoUrl" class="rounded" style="height:300px;" />
                    </td>

                </tr>
             
            </table>
        </div>
    </form>


@section scripts
{

<!--加入一些自己手寫的簡單jQuery語法-->
<script type="text/javascript">
    $(document).ready(function(){  
        $('#btnUpload').click(function () {  
  
            // Checking whether FormData is available in browser  
            if (window.FormData !== undefined) {  
  
                var fileUpload = $("#FileUpload1").get(0);  
                var files = fileUpload.files;  
              
                // Create FormData object  
                var fileData = new FormData();  
  
                // Looping over all files and add it to FormData object  
                for (var i = 0; i < files.length; i++) {  
                    fileData.append(files[i].name, files[i]);  
                }  
              
                // Adding one more key to FormData object  
                fileData.append('username', 'Manas');  
  
                $.ajax({  
                    url: '/PublicObject/PUB01/UploadFiles',
                    type: "POST",  
                    contentType: false, // Not to set any content header  
                    processData: false, // Not to process data  
                    data: fileData,  
                    success: function (data) {
                        //var res = JSON.parse(data.xhr.responseText);
                        var res = data;
                        if (res.Result) {
                            msg = "已成功上傳" + res.Count + "個檔案！";
                            window.setTimeout(function () {
                                $.modalMsg(msg, "success");
                            }, 500);

                        }
                        else {
                            msg = "上傳失敗，原因：" + res.Message;
                            window.setTimeout(function () {
                                $.modalMsg(msg, "error");
                            }, 500);
                        }
                        //alert(res.FileUrl);
                        //更新圖片欄位
                        //$('#PhotoUrl').val(data[0].value);
                        $('input[name=PhotoUrl]').val(res.FileUrl);
                        var EmpPhotoUrl = $('input[name=PhotoUrl]').val();
                        var photourl = EmpPhotoUrl.replace("~/", "");
                        $("#ObjectPhotoUrl").attr("src", pathlink + photourl);

                    },
                    error: function (err) {  
                        alert(err.statusText);  
                    }  
                });  
            } else {  
                alert("FormData is not supported.");  
            }  
        });  
    });  
</script>
}
